#include "sprites.h"

sprite asSprites[SPRITES_COUNT];

void initSprites ()
{
	position zeroPosition;	//out of screen = invisible;
	zeroPosition.x = 32;
	zeroPosition.y = 24;

	for (uint8_t currentSprite = 0; currentSprite < SPRITES_COUNT; currentSprite++)
	{
		asSprites[currentSprite].actionFunction = &emptySpriteFunction;
		asSprites[currentSprite].moveFunction = &defaultMoveFunction;
		asSprites[currentSprite].actionTime = 1;
		setSpriteColor(currentSprite, COLOR_WHITE);
		asSprites[currentSprite].newPosition = zeroPosition;
		asSprites[currentSprite].oldPosition = zeroPosition;
		setSpriteTexture(currentSprite, sprEmpty);
		stopSpriteTimer(currentSprite);
	}

	asSprites[0].assignedTimer = SPRITE0_TIMER_ID;
	asSprites[1].assignedTimer = SPRITE1_TIMER_ID;
	asSprites[2].assignedTimer = SPRITE2_TIMER_ID;
	asSprites[3].assignedTimer = SPRITE3_TIMER_ID;
	asSprites[4].assignedTimer = SPRITE4_TIMER_ID;
	asSprites[5].assignedTimer = SPRITE5_TIMER_ID;
	asSprites[6].assignedTimer = SPRITE6_TIMER_ID;
	asSprites[7].assignedTimer = SPRITE7_TIMER_ID;
}

void redrawSprite (uint8_t spriteId)
{
	GpuPutSprite(asSprites[spriteId].oldPosition.x,asSprites[spriteId].oldPosition.y,sprEmpty,COLOR_BLACK);
	GpuPutSprite(asSprites[spriteId].newPosition.x,asSprites[spriteId].newPosition.y,asSprites[spriteId].spriteTexture,asSprites[spriteId].spriteColor);
}

void refreshSprite (uint8_t spriteId)
{
	uint32_t timerValue;
	TimerRead(asSprites[spriteId].assignedTimer, &timerValue);

	if (timerValue >= asSprites[spriteId].actionTime)
	{
		uint8_t result = asSprites[spriteId].actionFunction(spriteId);
		if (result == 1)
		{
			stopSpriteTimer(spriteId);
		}
		else
		{
			restartSpriteTimer(spriteId);
		}
	}

	redrawSprite(spriteId);
}

void refreshSprites ()
{
	for (uint8_t currentSprite = 0; currentSprite < 1; currentSprite++)
	{
		refreshSprite (currentSprite);
	}
}

void clearSprite (uint8_t spriteId)
{
	position zeroPosition;	//out of screen = invisible;
	zeroPosition.x = 32;
	zeroPosition.y = 24;

	moveSpriteAbs(spriteId, zeroPosition);
	stopSpriteTimer(spriteId);
}

void moveSprite (uint8_t spriteId, int8_t deltaX, int8_t deltaY)
{
	asSprites[spriteId].moveFunction(spriteId, deltaX, deltaY);
}

void moveSpriteAbs (uint8_t spriteId, position newPosition)
{
	asSprites[spriteId].newPosition = newPosition;
}

void setSpriteTexture (uint8_t spriteId, spriteChar spriteTexture)
{
	asSprites[spriteId].spriteTexture = spriteTexture;
}

void setSpriteColor (uint8_t spriteId, uint32_t spriteColor)
{
	asSprites[spriteId].spriteColor = spriteColor;
}

void startSpriteTimer (uint8_t spriteId, uint32_t actionTime)
{
	TimerSet(asSprites[spriteId].assignedTimer);
	asSprites[spriteId].actionTime = actionTime;
}

void stopSpriteTimer (uint8_t spriteId)
{
	TimerClear(asSprites[spriteId].assignedTimer);
}

void restartSpriteTimer (uint8_t spriteId)
{
	TimerRestart(asSprites[spriteId].assignedTimer);
}

void assignSpriteActionFunction (uint8_t spriteId, uint8_t (*actionFunction)(uint8_t spriteId))
{
	asSprites[spriteId].actionFunction = actionFunction;
}

void assignSpriteMoveFunction (uint8_t spriteId, uint8_t (*moveFunction)(uint8_t spriteId, int8_t deltaX, int8_t deltaY))
{
	asSprites[spriteId].moveFunction = moveFunction;
}

uint8_t emptySpriteFunction (uint8_t spriteId)
{
	return 0;
}

uint8_t defaultMoveFunction (uint8_t spriteId, int8_t deltaX, int8_t deltaY)
{
	asSprites[spriteId].newPosition.x = asSprites[spriteId].oldPosition.x + deltaX;
	asSprites[spriteId].newPosition.y = asSprites[spriteId].oldPosition.y + deltaY;
	return 0;
}
